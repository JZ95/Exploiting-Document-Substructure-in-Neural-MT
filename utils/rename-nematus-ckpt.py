#!/usr/bin/env python3
import argparse
import tensorflow as tf
import re

def get_args():
    arg = argparse.ArgumentParser(description='rename ckpt file produced by nematus')
    arg.add_argument('-input', '-i', type=str, help='input ckptpoint name, i.e. prefix')
    arg.add_argument('-output', '-o', type=str, help='output ckptpoint name, i.e. prefix')
    return arg.parse_args()

## source code based on https://gist.github.com/batzner/7c24802dd9c5e15870b4b56e22135c96
def rename(checkpoint, output):
    with tf.Session() as sess:
        for var_name, _ in tf.contrib.framework.list_variables(checkpoint):
            # Load the variable            
            var = tf.contrib.framework.load_variable(checkpoint, var_name)
            # Set the new name
            new_name = re.sub(r'^encoder\/', 'word-encoder/', var_name)
            if var_name != new_name:
                print('Renaming %s to %s.' % (var_name, new_name))
            var = tf.Variable(var, name=new_name)

        saver = tf.train.Saver()
        sess.run(tf.global_variables_initializer())
        saver.save(sess, output_path)

if __name__ == '__main__':
    args = get_args()
    rename(args.input, args.output)
