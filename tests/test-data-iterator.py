#!/usr/bin/env python3
import sys
import os
main_dir = os.path.join(os.path.dirname(__file__), '../')
src_dir = os.path.join(main_dir, 'src')
sys.path.append(main_dir)
sys.path.append(src_dir)
from src.data_iterator import JointLearningWrapper, CLFTextIterator, StructureAwareNMTIterator, VanillaNMTTextIterator

def test_clf_iter():
    iter_ = CLFTextIterator(
        './data/clf-data.text', './data/clf-data.label', 
        ['./data/vocab.zh.json'], './data/cls_2_id.json',
        keep_data_in_memory=True,
        batch_size=3)
    for _ in range(3):
        for data in iter_:
            pass
            # print(data[0], data[1])

def test_vanilla_nmt_iter():
    iter_ = VanillaNMTTextIterator(
        './data/nmt-data.zh', './data/nmt-data.en', 
        ['./data/vocab.zh.json'], './data/vocab.en.json',
        keep_data_in_memory=False,
        batch_size=3)
    for _ in range(3):
        for data in iter_:
            pass
            # print(data[0], data[1])

def test_ctx_nmt_iter():
    iter_ = StructureAwareNMTIterator(
        './data/nmt-data.zh', './data/nmt-data.en', 
        ['./data/vocab.zh.json'], './data/vocab.en.json',
        keep_data_in_memory=True,
        batch_size=3)
    for _ in range(3):
        for data in iter_:
            pass
            # print(data[0], data[1])

def test_join_iter():
    nmt_iter_ = StructureAwareNMTIterator(
        './data/nmt-data.zh', './data/nmt-data.en', 
        ['./data/vocab.zh.json'], './data/vocab.en.json',
        keep_data_in_memory=True,
        batch_size=3)

    clf_iter_ = CLFTextIterator(
        './data/clf-data.text', './data/clf-data.label', 
        ['./data/vocab.zh.json'], './data/cls_2_id.json',
        keep_data_in_memory=True,
        batch_size=3)
    
    for _ in range(3):
        for data in JointLearningWrapper(nmt_iter_, clf_iter_, k=5):
            pass
            # print(data)

if __name__ == "__main__":
    test_clf_iter()
    test_vanilla_nmt_iter()
    test_ctx_nmt_iter()
    test_join_iter()
    print('all test passed')